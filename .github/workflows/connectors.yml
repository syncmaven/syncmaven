name: Build and Publish Connectors (Docker Images)

on:
#  push:
#    branches:
#      - main
#  pull_request:
#    branches:
#      - main
  workflow_dispatch:
    inputs:
      release-version:
        description: "Version. Can be either x.y.z or canary"
        required: true
      select:
        description: "Select connectors to build and publish (not implemented yet)"
        required: false
        default: "*"
jobs:
  build-node-based-connectors:
    name: "Build and Publish Node-based Connectors"
    #bogus check for future use, see above, this is always set
    if: github.event.inputs.release-version != ''
    strategy:
      matrix:
        connector: [resend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # need this for build id below
          fetch-depth: 0

      - name: Set build ID
        id: versions
        run: |
          echo "build_id=$(git rev-list --count HEAD).$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: "lab:latest"
          driver: cloud
          endpoint: "vklmn/vklmn"
      - name: Select Version Tag
        id: docker_tag
        run: |
          if [ "${{ github.ref == 'refs/heads/main' || github.event.inputs.release-version == 'canary' }}" == "true" ]; then
            echo tag=canary-${{ steps.versions.outputs.build_id }} >> "$GITHUB_OUTPUT"
          else
            echo tag=${{ github.event.inputs.release-version }} >> "$GITHUB_OUTPUT"
          fi
      - name: "Build and Push Docker Images: resend"
        uses: docker/build-push-action@v5
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          target: ${{ matrix.connector }}
          file: connectors.Dockerfile
          context: .
          tags: |
            syncmaven/${{ matrix.connector }}:${{ github.ref == 'refs/heads/main' || github.event.inputs.release-version == 'canary' && 'canary' || 'latest' }}
            syncmaven/${{ matrix.connector }}:${{ steps.docker_tag.outputs.tag }}
          outputs: type=registry,push=true
